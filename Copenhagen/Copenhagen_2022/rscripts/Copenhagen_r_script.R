########################################################
# COPENHAGEN CASE STUDY - R SCRIPT
#######################################################


# 01. Load pacman ---------------------------------------------------------


# Check if the 'pacman' package is installed, if not install it:
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")


# 02. Load required packages ----------------------------------------------


# Load the required libraries into the current R session:
pacman::p_load(rio, 
               here, 
               tidyverse, 
               skimr, 
               janitor,
               lubridate,
               gtsummary, 
               flextable,
               officer,
               EpiStats,
               epikit, 
               apyramid, 
               scales)


# 03. Check working directory ---------------------------------------------


here::here()



# 04. Import raw data -----------------------------------------------------


# Import the raw data set:
linelist <- rio::import(here::here("data", "Copenhagen_raw.csv"))



# 05. Explore data --------------------------------------------------------


# Explore data with skim:
drskim <- linelist %>% 
  # Select all columns with names that end in upper case 'D':
  select(ends_with("D", ignore.case = FALSE)) %>% 
  # Produce the skim summary table
  skimr::skim()


# Check range of maximum values across the selected columns:
range(drskim$numeric.p100)



# 06. Summarise dose response columns -------------------------------------


# Create summary table for dose response columns:
drtable <- linelist %>% 
  
  # Select all the columns with column names that end in upper case 'D':
  select(ends_with("D", ignore.case = FALSE)) %>% 
  
  # Create the summary table, excluding missing values:
  gtsummary::tbl_summary(missing = "no") %>% 
  
  # Convert to flextable:
  gtsummary::as_flex_table()

# Print the summary table:
drtable



# 07. Format logical columns ----------------------------------------------



# Convert cols to logical:
linelist <- linelist %>% 
  
  mutate(across(
    
    # Select columns that are numeric and where all values are 0, 1 or NA
    .cols = where(function(x) is.numeric(x) & all(x %in% c(0, 1, NA))), 
    
    # Convert columns matching these criteria to logical
    .fns = as.logical))




# 08. Recode values -------------------------------------------------------



# Histogram of age:
hist(linelist$age)


# Convert group to factor:
linelist <- linelist %>% 
  
  # Convert group to a factor and label 0 as teacher, 1 as student:
  mutate(group = factor(group, labels = c("teacher", "student")))



# 09. Cross-tabulate age and group ----------------------------------------



# Create cross-tab:
janitor::tabyl(dat = linelist, age, group)



# Update incorrect ages to the correct values with case_when:
linelist <- linelist %>% 
  
  mutate(age = 
           case_when(
             # Where the respondent is 16 and a teacher, change their age to 61:
             age == 16 & group == "teacher" ~ 61, 
             # where the respondent is 8 or 180 and a student, change their age to 18:
             age %in% c(8, 180) & group == "student" ~ 18, 
             # Keep remaining values as is: 
             TRUE ~ as.numeric(age)
           )
  )


# Create cross-tab:
janitor::tabyl(dat = linelist, age, group)


# Check variable sex:
janitor::tabyl(linelist, sex)

# Check variable class:
janitor::tabyl(linelist, class)

# Get linelist and pipe it in:
linelist <- linelist %>% 
  
  # Now call 'mutate' to update the variables:
  mutate(
    sex = factor(sex, labels = c("female", "male")),
    class = factor(class)
    )


# Final skim of the data before analysis:
skimr::skim(linelist)



# 10. Define case ---------------------------------------------------------

# Define meal_datetime:

# Start with linelist:
linelist <- linelist %>% 
  
  # Create new column for meal date and time:
  mutate(meal_datetime = lubridate::ymd_hm("2006-11-11 18:00"))


# Define gastro symptoms:

# Define a list of gastro symptom columns:
gastro_cols <- c("diarrhoea", "bloody", "vomiting")


# Start with linelist:
linelist <- linelist %>% 
  
  # Create a new column called gastrosymptoms:
  mutate(gastrosymptoms = case_when(
    
    # gastrosymptoms = FALSE if none of the gastro columns are TRUE:
    if_all(.cols = all_of(gastro_cols), 
           .fns = ~ !. %in% c(TRUE)) ~ FALSE,
    
    # gastrosymptoms = TRUE if any of the gastro columns are TRUE:
    if_any(.cols = any_of(gastro_cols), 
           .fns = ~ . == TRUE) ~ TRUE
    
  ))


# How many people had no data for any of the symptoms of interest?
nosymptoms <- linelist %>% 
  filter(if_all(.cols = all_of(gastro_cols), .fns = ~ is.na(.))) %>% 
  count() %>% 
  pull()

# Print result:
nosymptoms

# Of these, how many also had a meal at the school dinner party?
nosymptoms_meal <- linelist %>% 
  filter(if_all(.cols = all_of(gastro_cols), 
                .fns = ~ is.na(.)) & meal == TRUE) %>% 
  count() %>% 
  pull()

# Print results:
nosymptoms_meal


# Get list of variable names in the data:
names(linelist)

# Choose the exposure variables:

# Create list of exposure variables to analyse:
exposure_cols <- c("tuna", 
                   "shrimps", 
                   "green", 
                   "veal", 
                   "pasta", 
                   "rocket", 
                   "sauce", 
                   "bread", 
                   "champagne", 
                   "beer", 
                   "redwine", 
                   "whitewine")


# Define ate_anything:

# Start with the linelist:
linelist <- linelist %>% 
  
  # Create ate_anything column:
  mutate(ate_anything = case_when(
    
    # ate_anything = FALSE if none of the exposure columns are TRUE:
    if_all(.cols = all_of(exposure_cols), 
           .fns = ~ !. %in% c(TRUE)) ~ FALSE,
    
    # ate_anything = TRUE if any of the exposure columns are TRUE:
    if_any(.cols = any_of(exposure_cols), 
           .fns = ~ . == TRUE) ~ TRUE
    
  ))


# Start with linelist:
linelist %>% 
  
  # Cross-tabulate meal with ate_anything:
  tabyl(meal, ate_anything)



# Update meal:

# Start with linelist:
linelist <- linelist %>% 
  
  # Change respondents who ate a food or drink item to meal = TRUE:
  mutate(meal = if_else(
    condition = meal == FALSE & ate_anything == TRUE, 
    true = TRUE, 
    false = meal
  ))


# Create case definition:

# Start with linelist:
linelist <- linelist %>% 
  
  # Create case definition:
  mutate(
    case = case_when(
      
      # Cases have any gastro symptoms with onset after the meal:
      meal == TRUE & 
        gastrosymptoms == TRUE & 
        !is.na(onset_datetime) & 
        (onset_datetime >= meal_datetime) 
      ~ TRUE, 
      
      # Non cases have no gastro symptoms but ate a meal at the party:
      meal == TRUE & 
        (gastrosymptoms == FALSE | 
           # ... or have gastro symptoms but onset is before the meal:
           (gastrosymptoms == TRUE & (onset_datetime < meal_datetime))) 
      ~ FALSE,
      
      # Define excluded individuals as those with no record of a meal:
      meal == FALSE | is.na(meal) 
      ~ NA
      
    )
  )


# First check how many people ate a meal at the dinner party:
atemeal <- linelist %>% 
  filter(meal == TRUE) %>% 
  count(meal) %>% 
  pull()

# Print the result:
atemeal

# Next, check how many people ate a meal AND had onset after the meal:
atemealsick <- linelist %>% 
  filter(meal == TRUE & (onset_datetime >= meal_datetime)) %>% 
  count(meal) %>% 
  pull()

# Print the result:
atemealsick

# Finally check how many people ate a meal AND fell ill afterwards with 
# any of diarrhoea, bloody diarrhoea, or vomiting:
atemealsickcase <- linelist %>% 
  filter(meal == TRUE & 
           (diarrhoea == TRUE | bloody == TRUE | vomiting == TRUE) & 
           (onset_datetime >= meal_datetime)) %>% 
  count(meal) %>% 
  pull()

# Print the result:
atemealsickcase



# First, we can makes sure that only case incubation times are examined:
linelist <- linelist %>% 
  
  # Update incubation to be NA if case is not TRUE:
  mutate(incubation = ifelse(test = case == TRUE, 
                             yes = onset_datetime - meal_datetime, 
                             no = NA))

# Median incubation time:
med_incubation <- median(linelist$incubation, na.rm = TRUE)

# Print the result:
med_incubation


# Tabulate case:
janitor::tabyl(dat = linelist, case)


# Update the case definition to limit to onset three days after meal:
linelist <- linelist %>% 
  
  mutate(case = case_when(
    
    # If respondent is a case but onset is more than two days after the meal
    # Change them to a non-case (FALSE)
    case == TRUE & (onset_datetime > (meal_datetime + days(2))) ~ FALSE, 
    
    # For everyone else, keep their current case status as is:
    TRUE ~ case
    
  )
  )


# Retabulate cases to see if anything has changed:
janitor::tabyl(dat = linelist, case)

# Cross-tabulate onset date time with case status:
janitor::tabyl(dat = linelist, onset_datetime, case) %>% 
  adorn_totals()


# Subset and open the records in the viewer:
View(subset(linelist, onset_datetime == ymd_hms("2020-06-11 11:00:00")))


linelist <- linelist %>%

  # Remove rows where case is NA:
  drop_na(case)

# Export clean linelist:
rio::export(x = linelist, 
            file = here::here("data", "Copenhagen_clean.xlsx"))



# Descriptive analysis ----------------------------------------------------



# Descriptive analysis {.tabset .tabset-pills}

## Introduction

### Recap

In part 1 of the *Copenhagen* case study, you: 

   + imported the outbreak linelist
   + cleaned the data
   + reformatted variables
   + checked for plausibility and errors
   + defined new variables
   + exported the clean data to a new Microsoft Excel file
   + created some exploratory tables, counts and histograms


It may be useful to reflect on what you have done so far.  Specifically:

   + Was there anything you struggled with and could not find a solution for? 
   + Which `R` concepts where new to you?


### Goals

In this session, we will perform some descriptive analysis.  Typically, we would describe the outbreak in terms of time, place and person.  In this data set, we don't have geospatial information, but we do have time (onset dates and times, incubation periods) and person (age, sex, clinical symptoms).  You will:
  
  + Describe cases by age and sex (create an age sex pyramid)
+ Describe case symptoms
+ Describe and illustrate incubation periods
+ Create an epidemic curve
+ Calculate attack proportions
+ summarise the analysis so far and generate hypotheses:
  + Any surprising findings regarding cohort characteristics?
  + Does the shape of the epicurve support a viral or toxic aetiology?
  + What other information can you obtain from the epicurve?
  + Does the summary of symptoms help you narrow down the suspect agent?
  + Do you have any hypothesis about the vehicle of infection so far?
  
  
  ### R prep
  
  In this section, we will begin to build a picture of the characteristics of this outbreak by performing some descriptive analysis.

If you closed RStudio after the last section, remember that when you restart or reopen RStudio, you will need to:
  
  + Open RStudio via the R project file in the case study materials folder
+ Open your R script or R markdown document from the files pane in RStudio
+ Load the required packages (run this chunk: \@ref(load-pkgs))
+ Rerun the code to clean the data set, or:
  + Import the cleaned data set that you saved at the end of the last session.


For convenience, we will start by importing the cleaned data set:
  
  ```{r import_clean_data}

# Import the cleaned data set using rio and here packages:
linelist <- rio::import(here::here("data", "Copenhagen_clean.xlsx")) %>% 
  
  # Convert character columns to factors:
  mutate(across(.cols = where(is.character), 
                .fns = as.factor))

```


Many of the descriptive features can be illustrated graphically, for which we will use the package `ggplot2`.

We will also create summary tables, using `janitor::tabyl()` for further exploration and the `gtsummary` package to create nicely formatted tables that can be used in reports and other publications.

For more detail on `tabyl()` function and the `adorn_XYZ`-helpers, see the [`janitor`-documentation](https://cran.r-project.org/web/packages/janitor/vignettes/tabyls.html) or [*The Epidemiologist R Handbook* section on tabulation](https://epirhandbook.com/en/descriptive-tables.html#tbl_janitor).
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       To create some of the summary tables, we will need to describe and calculate summary statistics for multiple columns in the same way.  There are special functions in `tidyverse` packages that make it easier to *iterate* over multiple columns and apply the same calculations to them, without having to repeat the code for each one.  We already saw how this worked with `across()`, `if_any()` and `if_all()`in the previous section.  The `purrr` package, which is part of the tidyverse, has several `map()` functions that extend this capability to more complex use cases.  
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       However, in this case study, we will mainly take advantage of the convenience functions in the `gtsummary` package, which has relatively simple syntax to create common summary statistics.  Most of these functions can take a list of columns as input and will iterate over them to create the table.  The default settings of `gtsummary` tables are in most cases already adequate for publication, but the individual features can also be customised.  You can find further information in the [Epidemiologist R handbook section on gtsummary](https://www.epirhandbook.com/en/descriptive-tables.html#tbl_gt).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \pagebreak
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ## Analysis plan
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              In theory, you create an analysis plan before data collection - it is an important way to ensure you collect all the data you need and that you *only* collect the data you need (think: data protection!). However, during outbreak investigations, you may need to deploy questionnaires as soon as possible and before a plan has been developed. In these cases, your experience will be an important resource to fall back on. 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              **Section goals**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                In this section, you will learn how to develop an analysis plan to help guide the descriptive and analytical analyses.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              **Questions to answer**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                In your analysis plan you should create a document to include:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                + research question(s) and hypothesis
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + dataset(s) to be used
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + inclusion / exclusion criteria for records you will use in your analysis
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + list of variables that will be used in the main analysis; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + outcome variable (being a case)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + main exposure variables (e.g. food consumed)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + stratifying variables (e.g. age, sex, group, class)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + statistical methods
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + key mock-up tables including title, labels and expected format for results
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + univariable
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + bivariable
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + stratified 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \pagebreak
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ## Person
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              In this section, we will describe the outbreak in terms of personal characteristics (age, sex and symptoms of cases).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ### Age & sex
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              During the data cleaning exercise, we already looked at the age characteristics of the cohort, since there were some typographic errors that needed to be corrected.  However, we have not yet looked at the distribution of cases and non-cases by sex.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              We can start by cross-tabulating with `tabyl()`:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                **Cross-tabulation of cases with sex**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ```{r sex_tabyl}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              linelist %>% 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                janitor::tabyl(case, sex)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ```
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              What do you notice about the distribution of females and males?  Is it the same in cases and non cases?
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                This might be better answered by looking at proportions.  We can do this with the `gtsummary::tbl_summary()` function, which also makes it easy to summarise other variables in a publication-ready table.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              We select the variables from `linelist` that we want to show in the table, before passing them to the `tbl_summary()` function.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              Next, we specify that we want to stratify the variables by `case`.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              We can also choose what statistics to show and what tests to use:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                + *Categorical variables:* *N* and % are shown and tested with chi square
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              + *Continuous variables:* mean and SD are shown and tested with t test
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              We have also formatted the column and row headers and footnotes, using the `str_glue()` function to stitch together text and R code to produce the summary counts.  The R code is enclosed in curly braces `{}`.  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              While this isn't essential (the defaults are ok) it makes the table a bit easier to read. The [gtsummary vignette](https://www.danieldsjoberg.com/gtsummary/articles/tbl_summary.html) is a good source of further information on customizing and formatting options.  


**Table of personal characteristics stratified by case definition**

```{r sex_gtsummary}

tabsex <- linelist %>%
  
  # Select person characteristics to summarise:
  select(case, age, sex, group, class) %>% 
  
  # Create the summary table:
  gtsummary::tbl_summary(
    
    # Stratify by case:
    by = case, 
    
    # Statistics to use for continuous and categorical variables:
    statistic = list(all_continuous() ~ "{mean} ({sd})",        
                     all_categorical() ~ "{n} ({p}%)"), 
    
    # Calculate row percentages:
    percent = "row",
    
    # Don't show missing values:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                missing = "no"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                       ) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add tests of statistical significance of differences between groups:
                                                                                                                                                                                                                                         add_p(test = list(all_continuous() ~ "t.test",       # Continuous variables
                                                                                                                                                                                                                                                           all_categorical() ~ "chisq.test"), # Categorical variables
                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                               # Identify grouping variable:
                                                                                                                                                                                                                                               group = case,
                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                               # Define any test arguments that deviate from the default:
                                                                                                                                                                                                                                               test.args = list(all_tests("t.test") ~ 
                                                                                                                                                                                                                                                                  list(var.equal = FALSE), 
                                                                                                                                                                                                                                                                all_tests("chisq.test") ~ 
                                                                                                                                                                                                                                                                  list(simulate.p.value = TRUE))) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add totals:
                                                                                                                                                                                                                                         add_overall() %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Individually label which row had which statistical test: 
                                                                                                                                                                                                                                         separate_p_footnotes() %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Make variable names bold and italics:
                                                                                                                                                                                                                                         bold_labels() %>% 
                                                                                                                                                                                                                                         italicize_labels() %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Modify header:
                                                                                                                                                                                                                                         modify_header(
                                                                                                                                                                                                                                           label = "**Characteristic**",
                                                                                                                                                                                                                                           stat_0 = "**Overall**\n *N* = {N}",
                                                                                                                                                                                                                                           stat_1 = "**Non-case**\n *N* = {n}",
                                                                                                                                                                                                                                           stat_2 = "**Case**\n *N* = {n}", 
                                                                                                                                                                                                                                           p.value = "**P value**"
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                         ) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Convert to flextable:
                                                                                                                                                                                                                                         gtsummary::as_flex_table()
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print the table:
                                                                                                                                                                                                                                       tabsex
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       **Questions to consider:**
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         1. What do you think of these results?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       An alternative way of looking at age and sex distributions is to create an age-sex pyramid. 
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       To prepare the data, we will first create an age category variable with the `epkit` function `age_categories()`:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r define_age_cat}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       linelist <- linelist %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Create age categories:
                                                                                                                                                                                                                                         mutate(age_cat = epikit::age_categories(
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Name of age column:
                                                                                                                                                                                                                                           x = age, 
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Define the age categories:
                                                                                                                                                                                                                                           breakers = c(0, 10, 16, 18, 20, 50, 70)
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                         )
                                                                                                                                                                                                                                         )
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Since we already know that the distribution of age in the outbreak cohort is quite skewed, it could be helpful to use smaller age bands for (teenage) students and bigger age bands for (adult) teachers (who are sparse).  
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Now we can check how the age bands look:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r check_age_cat}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Check age categories:
                                                                                                                                                                                                                                       janitor::tabyl(linelist, age_cat)
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Once we are happy with the age categories, we can use them to create an age-sex pyramid, using the `apyramid` package:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         **Age sex pyramid of cases**
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r age_sex_pyramid}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Pipe linelist:
                                                                                                                                                                                                                                       agesex <- linelist %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Filter for cases only:
                                                                                                                                                                                                                                         filter(case == TRUE) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Create age sex pyramid:
                                                                                                                                                                                                                                         apyramid::age_pyramid(
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Specify column containing age categories:
                                                                                                                                                                                                                                           age_group = "age_cat",
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Specify column containing sex:
                                                                                                                                                                                                                                           split_by = "sex", 
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Don't show midpoint on the graph:
                                                                                                                                                                                                                                           show_midpoint = FALSE
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                         )
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print plot:
                                                                                                                                                                                                                                       agesex
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       What do you notice when age and sex are combined in this figure?  
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         Try producing the figure again, but this time without filtering by case. Do you see any differences in the pattern?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         (Hint: change `show_midpoint = FALSE` to `TRUE` to see skewedness in the data patterns more easily).
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ### Symptoms
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       In the first part of this case study, we selected three symptoms to use in the case definition; these were diarrhoea (with or without blood) and vomiting.  However, other symptoms were also recorded in the survey.  
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       It may be useful to determine which symptoms are most common among cases and non-cases.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       First, we can create a list of all the symptom variables in the data:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r symptom_vars}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Check list of variable names:
                                                                                                                                                                                                                                       names(linelist)
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Create list of symptom variables:
                                                                                                                                                                                                                                       symptoms <- c("diarrhoea", 
                                                                                                                                                                                                                                                     "bloody", 
                                                                                                                                                                                                                                                     "vomiting", 
                                                                                                                                                                                                                                                     "abdo", 
                                                                                                                                                                                                                                                     "nausea", 
                                                                                                                                                                                                                                                     "fever", 
                                                                                                                                                                                                                                                     "headache", 
                                                                                                                                                                                                                                                     "jointpain")
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Now we can create a summary table with `gtsummary` with symptoms stratified by case:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         **Table of symptoms stratified by case definition**
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r symptoms_tab}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Create summary table:
                                                                                                                                                                                                                                       tabsymptoms <- linelist %>%
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Select person characteristics to summarise:
                                                                                                                                                                                                                                         select(case, all_of(symptoms)) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Create the summary table:
                                                                                                                                                                                                                                         gtsummary::tbl_summary(
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Stratify by case:
                                                                                                                                                                                                                                           by = case, 
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Statistics to use for continuous and categorical variables:
                                                                                                                                                                                                                                           statistic = list(all_continuous() ~ "{mean} ({sd})",        
                                                                                                                                                                                                                                                            all_categorical() ~ "{n} ({p}%)"), 
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Don't show missing values:
                                                                                                                                                                                                                                           missing = "no",
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Sort the data:
                                                                                                                                                                                                                                           sort = list(everything() ~ "frequency"), 
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Create nice labels:
                                                                                                                                                                                                                                           label  = list(
                                                                                                                                                                                                                                             diarrhoea   ~ "Diarrhoea",                           
                                                                                                                                                                                                                                             bloody      ~ "Dysentary",
                                                                                                                                                                                                                                             vomiting    ~ "Vomiting",
                                                                                                                                                                                                                                             abdo        ~ "Abdominal pain",
                                                                                                                                                                                                                                             nausea      ~ "Nausea", 
                                                                                                                                                                                                                                             fever       ~ "Fever", 
                                                                                                                                                                                                                                             headache    ~ "Headache", 
                                                                                                                                                                                                                                             jointpain   ~ "Joint pain")
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                         ) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add tests of statistical significance of differences between groups:
                                                                                                                                                                                                                                         add_p(test = list(all_continuous() ~ "t.test",       # Continuous
                                                                                                                                                                                                                                                           all_categorical() ~ "chisq.test"), # Categorical
                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                               # Identify grouping variable:
                                                                                                                                                                                                                                               group = case,
                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                               # Define any test arguments that deviate from the default:
                                                                                                                                                                                                                                               test.args = list(all_tests("t.test") ~ 
                                                                                                                                                                                                                                                                  list(var.equal = FALSE), 
                                                                                                                                                                                                                                                                all_tests("chisq.test") ~ 
                                                                                                                                                                                                                                                                  list(simulate.p.value = TRUE))) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add totals:
                                                                                                                                                                                                                                         add_overall() %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Individually label which row had which statistical test: 
                                                                                                                                                                                                                                         separate_p_footnotes() %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Make variable names bold and italics:
                                                                                                                                                                                                                                         bold_labels() %>% 
                                                                                                                                                                                                                                         italicize_labels() %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Modify header:
                                                                                                                                                                                                                                         modify_header(
                                                                                                                                                                                                                                           label = "**Characteristic**",
                                                                                                                                                                                                                                           stat_0 = "**Overall**\n *N* = {N}",
                                                                                                                                                                                                                                           stat_1 = "**Non-case**\n *N* = {n}",
                                                                                                                                                                                                                                           stat_2 = "**Case**\n *N* = {n}", 
                                                                                                                                                                                                                                           p.value = "**P value**"
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                         ) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Convert to flextable for printing:
                                                                                                                                                                                                                                         gtsummary::as_flex_table()
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print the table:
                                                                                                                                                                                                                                       tabsymptoms
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Looking at the table, do you think the symptoms selected for the case definition were the right ones, or would you change anything?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         This might be a bit easier to assess if we look at the symptoms in an ordered bar chart.  To do this, we will need to reshape the data, so that one column contains symptoms and another column contains the proportion of respondents with a given symptom in each case.  We will use `pivot_longer()` to reshape the data, then `group_by()`, `summarise()` and `count()` to tally up the counts for each symptom, stratified by case definition.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       We can then create the bar plot with `ggplot()`.  
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Finally, when specifying the aesthetics, we can reorder the symptom bars on the x axis by count in descending order.  This will also help to make the plot more legible and easier to interpret.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Note that this type of figure is best flipped on its side (which we do with `ggplot2::coord_flip()`), as this makes the axis labels easier to read and the bars easier to compare.  Even though the axes are flipped, we still need to refer to symptoms as the x axis and count as the y axis.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       **Bar plot of symptoms stratified by case definition**
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r symptom_barplot}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Create nice labels for case definition:
                                                                                                                                                                                                                                       caselabs <- ggplot2::as_labeller(c(`FALSE` = "Non-case", 
                                                                                                                                                                                                                                                                          `TRUE` = "Case"))
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Select variables and cases:
                                                                                                                                                                                                                                       symptom_bar <- linelist %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Select symptom columns:
                                                                                                                                                                                                                                         select(case, c(all_of(symptoms))) %>%
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Drop NAs:
                                                                                                                                                                                                                                         drop_na() %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Reshape (pivot longer):
                                                                                                                                                                                                                                         pivot_longer(!case, 
                                                                                                                                                                                                                                                      names_to = "Symptoms", 
                                                                                                                                                                                                                                                      values_drop_na = TRUE) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Keep only TRUE values:
                                                                                                                                                                                                                                         filter(value == TRUE) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Group by symptoms and case:
                                                                                                                                                                                                                                         group_by(Symptoms, case) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Count for each symptom by case:
                                                                                                                                                                                                                                         summarise(count = n()) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Create plot:
                                                                                                                                                                                                                                         ggplot(aes(
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Order symptom bars so most common ones are ontop:
                                                                                                                                                                                                                                           x = reorder(Symptoms, desc(count), decreasing = TRUE), 
                                                                                                                                                                                                                                           y = count)) +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Display bars as proportions
                                                                                                                                                                                                                                         geom_bar(stat = "identity") +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Update x axis label:
                                                                                                                                                                                                                                         xlab("Symptoms") +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Update y axis label:
                                                                                                                                                                                                                                         ylab("Proportion of respondents") +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Flip plot on its side so symptom labels are clear:
                                                                                                                                                                                                                                         coord_flip() +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Facet the plot by (labelled) case:
                                                                                                                                                                                                                                         facet_wrap(facets = "case",
                                                                                                                                                                                                                                                    labeller = caselabs,
                                                                                                                                                                                                                                                    ncol = 2)
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print plot:
                                                                                                                                                                                                                                       symptom_bar
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       What do you make of the symptoms now?  
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         Does the pattern of symptoms help you hypothesise about the aetiological agent of this outbreak? 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         If so, what do you think it is?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ### Attack proportions
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         You can calculate crude attack proportions and attack proportions stratified by different variables of interest. Commonly, *attack proportions* are also called "*attack rates*" but please note that "*attack rate*" is a misnomer and should not be used: "*attack rates*" are not *rates*, but rather *proportions*. Mathematically, a *rate* is defined as a change in one unit per change in another unit. For example, think about velocity: the distance traveled per time passed, typically measured in *meters*/*seconds*. Other examples include decay of radioactive material with *decays*/*seconds*, or widely used in epidemiology: *incidence rate* - the number of new cases per month/year/etc. Crucially, *rates* have no upper limit: 10, 100, 1000 individuals can fall sick per month. *Proportions*, in contrast, compare the amount of something to the amount of the whole. *Attack proportions* compare the number of those having become sick to the size of the whole sample. As such, *attack proportions* can never be greater than 1 or 100% - at maximum, the entire sample became ill. 
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Thus, the *attack proportion* is simply the percentage of Cases among the total observed individuals and can be calculated quite easily.  
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       We will take advantage of `tabyl()` to calculate the percentages for us.  We can then use `filter()`, `select()` and `pull()` to extract the attack proportion of cases.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```{r attack_prop_overall}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Create table of case status:
                                                                                                                                                                                                                                       total_ap <- tabyl(linelist, case) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add row totals:
                                                                                                                                                                                                                                         adorn_totals(where = "row") %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add percentages with 1 digit after the decimal point:
                                                                                                                                                                                                                                         adorn_pct_formatting(digits = 1) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Filter to rows where case is TRUE:
                                                                                                                                                                                                                                         filter(case == TRUE) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Select the column percent:
                                                                                                                                                                                                                                         select(percent) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Extract (pull) the value from this cell:
                                                                                                                                                                                                                                         pull()
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print result:
                                                                                                                                                                                                                                       total_ap
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       What can you infer from the overall attack proportion about this outbreak and possible vehicles / exposures?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         It would also be interesting to stratify the attack proportion by another variable.  First we will look at `group` (students vs. teachers). 
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Does the attack proportion differ, when we compare teachers and students (group variable)?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r attack_prop_students}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Attack proportion for students:
                                                                                                                                                                                                                                       students_ap <- tabyl(linelist, group, case) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         adorn_totals("row") %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         adorn_percentages("row") %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         adorn_pct_formatting(digits = 1) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         filter(group == "student") %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         select(`TRUE`) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         pull()
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Attack proportion for teachers:
                                                                                                                                                                                                                                       teachers_ap <- tabyl(linelist, group, case) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         adorn_totals("row") %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         adorn_percentages("row") %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         adorn_pct_formatting(digits = 1) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         filter(group == "teacher") %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         select(`TRUE`) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         pull()
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print result:
                                                                                                                                                                                                                                       students_ap
                                                                                                                                                                                                                                       teachers_ap
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       The attack proportion among students is `r students_ap`, while for teachers, the attack proportion is `r teachers_ap`. Of course, we would like to to know if attack proportions differ when stratifying by other variables, too.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       We can use the `tbl_summary()` function from the `gtsummary` package as before, to calculate attack proportions for group, class and sex by case status.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```{r attack_prop}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Table to calculate attack proportions:
                                                                                                                                                                                                                                       attack_prop <- linelist %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Select columns:
                                                                                                                                                                                                                                         select (case, group, class, sex) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Create table:
                                                                                                                                                                                                                                         tbl_summary(
                                                                                                                                                                                                                                           # Stratified by case
                                                                                                                                                                                                                                           by = case, 
                                                                                                                                                                                                                                           # With row percentages
                                                                                                                                                                                                                                           percent = "row") %>%
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add totals:
                                                                                                                                                                                                                                         add_overall() %>%
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add p values:
                                                                                                                                                                                                                                         add_p() %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Make variable names bold and italics:
                                                                                                                                                                                                                                         bold_labels() %>% 
                                                                                                                                                                                                                                         italicize_labels() %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Modify header:
                                                                                                                                                                                                                                         modify_header(
                                                                                                                                                                                                                                           label = "**Characteristic**",
                                                                                                                                                                                                                                           stat_0 = "**Overall**\n *N* = {N}",
                                                                                                                                                                                                                                           stat_1 = "**Non-case**\n *N* = {n}",
                                                                                                                                                                                                                                           stat_2 = "**Case**\n *N* = {n}", 
                                                                                                                                                                                                                                           p.value = "**P value**"
                                                                                                                                                                                                                                         )
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print table:
                                                                                                                                                                                                                                       attack_prop
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       We can see that although there are minor differences in attack proportion by group, class and sex, none are statistically significant. Remember that there are much fewer teachers than students. 
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       What can you conclude from this?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         \pagebreak
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ## Time
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       In this session , we will take a closer look at incubation periods and also construct an epicurve.  The incubation period can be a useful guide to determine what units and intervals to use in the epicurve.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ### Incubation period
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       > The incubation period of a disease is the time from an exposure resulting in infection until the onset of disease. Because infection usually occurs immediately after exposure, the
                                                                                                                                                                                                                                       incubation period is generally the duration of the period from the onset of infection to the onset of disease.
                                                                                                                                                                                                                                       > 
                                                                                                                                                                                                                                         > `r tufte::quote_footer('--- Rothman, Greenland, Lash (2017): Modern Epidemiology, 3rd edition')`
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       In the previous section, we calculated incubation period by subtracting the meal date and time from the date and time of symptom onset.  This gave us the incubation period in hours.  We can now look at this on a graph:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         **Plot of incubation period:**
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r incubation_ggplot}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       incplot <- linelist %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Remove missing values:
                                                                                                                                                                                                                                         drop_na(incubation) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Create an empty ggplot frame:
                                                                                                                                                                                                                                         ggplot() +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add a histogram of incubation:
                                                                                                                                                                                                                                         geom_histogram(aes(x = incubation), 
                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                        # Set bin widths to 6 hours:
                                                                                                                                                                                                                                                        binwidth = 6) +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Adapt scale to better fit data
                                                                                                                                                                                                                                         scale_x_continuous(breaks = seq(0, 48, 6)) + 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Label x and y axes:
                                                                                                                                                                                                                                         labs(x = "Incubation period in 6-hour bins",
                                                                                                                                                                                                                                              y = "Number of cases")
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print plot:
                                                                                                                                                                                                                                       incplot
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       What can you infer from the incubation periods on the histogram?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ### Epidemic curve
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         To create an *epicurve*, we are going to use `ggplot2`. `ggplot2` is a versatile package that helps create beautiful visualizations in `R`. There are plenty good in-depth guides to the package, for example: [*The Epidemiologist R Handbook* Chapter on *ggplot*](https://epirhandbook.com/en/ggplot-basics.html) and [*ggplot2 - Elegant Graphics for Data Analysis*](https://ggplot2-book.org/index.html). 
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       First, we can create an epicurve for the date of onset, limiting the input data to cases:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r epicurve_date}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Fetch data:
                                                                                                                                                                                                                                       epicurve_date <- linelist %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Filter for cases where dayonset is not missing:
                                                                                                                                                                                                                                         filter(case == TRUE & !is.na(dayonset)) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add factor onset_day to ggplot aesthetic:
                                                                                                                                                                                                                                         ggplot(aes(x = dayonset)) + 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add geom_bar:
                                                                                                                                                                                                                                         geom_bar() +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Adapt scale to data and adjust axis label angle:
                                                                                                                                                                                                                                         scale_x_datetime(
                                                                                                                                                                                                                                           date_breaks = "1 day",
                                                                                                                                                                                                                                           labels = label_date_short()) +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Update x and y axis labels:
                                                                                                                                                                                                                                         labs(x = "Date of onset", 
                                                                                                                                                                                                                                              y = "Number of cases") +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Remove unnecessary grid lines:
                                                                                                                                                                                                                                         theme_bw()
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print epicurve:
                                                                                                                                                                                                                                       epicurve_date
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       As you can see, the epicurve is quite crude, because most cases had their disease onset on 12 November. To increase resolution, we could enhance the time information to include both day and hour.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       During the data preparation session, we already concatenated the variables `dayonset` and `starthour` together and formatted them with the `lubridate` package to create a new date-time variable called `onset_datetime`.  We can now create the epicurve with this variable:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r epicurve_hour}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Fetch data:
                                                                                                                                                                                                                                       epicurve_hour <- linelist %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Filter for cases where dayonset is not missing:
                                                                                                                                                                                                                                         filter(case == TRUE & !is.na(onset_datetime)) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add factor onset_day to ggplot aesthetic:
                                                                                                                                                                                                                                         ggplot(aes(x = onset_datetime)) + 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add geom_histogram:
                                                                                                                                                                                                                                         geom_bar() +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Adjust x axis scales to a suitable unit:
                                                                                                                                                                                                                                         scale_x_datetime(
                                                                                                                                                                                                                                           date_breaks = "6 hours", 
                                                                                                                                                                                                                                           labels = label_date_short()) +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Update x and y axis labels:
                                                                                                                                                                                                                                         labs(x = "Date and time of onset", 
                                                                                                                                                                                                                                              y = "Number of cases") +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Remove unnecessary grid lines:
                                                                                                                                                                                                                                         theme_bw()
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print epicurve:
                                                                                                                                                                                                                                       epicurve_hour
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Finally, we could compare the epicurve between the sexes and additionally investigate how teachers versus students were distributed. Here, `fill`  adds an additional variable to be displayed in the plot: `group` is going to determine the fill-colour of our bars. `facet_wrap` splits the graph in two: one each for the two levels of `sex`. 
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       We will also use the function `str_glue()` to add the total number of cases to the sub-title of the plot.  `str_glue()` is a very useful function that allows you to dynamically create a summary statistic from your data within some normal text.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```{r epicurve_stratified}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Fetch data:
                                                                                                                                                                                                                                       epicurve_strata <- linelist %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Filter for cases where dayonset is not missing:
                                                                                                                                                                                                                                         filter(case == TRUE & !is.na(onset_datetime)) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add factor onset_day to ggplot aesthetic:
                                                                                                                                                                                                                                         ggplot(aes(x = onset_datetime, fill = group)) + 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add nicer fill colours:
                                                                                                                                                                                                                                         scale_fill_manual(values = c("darkred", "lightblue")) +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add geom_histogram:
                                                                                                                                                                                                                                         geom_bar() +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Adjust x axis scales to a suitable unit:
                                                                                                                                                                                                                                         scale_x_datetime(
                                                                                                                                                                                                                                           date_breaks = "6 hours", 
                                                                                                                                                                                                                                           labels = label_date_short()) +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Update x and y axis labels:
                                                                                                                                                                                                                                         labs(x = "Date and time of onset", 
                                                                                                                                                                                                                                              y = "Number of cases", 
                                                                                                                                                                                                                                              fill = "Group", 
                                                                                                                                                                                                                                              title = "Epicurve of the outbreak, stratified by sex",
                                                                                                                                                                                                                                              subtitle = str_glue("Copenhagen, November 2006, N = {sum(linelist$case)}")) +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Stratify by sex:
                                                                                                                                                                                                                                         facet_wrap(facets = "sex",
                                                                                                                                                                                                                                                    ncol = 2) +
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add theme:
                                                                                                                                                                                                                                         theme_bw()
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print epicurve:
                                                                                                                                                                                                                                       epicurve_strata
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       What does the stratified epicurve tell you?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         Try stratifying by some other variables (for example a symptom, or age categories) to explore the temporal distribution further.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       \newpage
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ------------------------------------------------------------------------
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Univariable analysis {.tabset .tabset-pills}
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ## Risk ratios
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ### Introduction
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         To identify the potential vehicle(s) of infection in the outbreak, we will proceed with an analytical study where statistical tests are used to investigate the associations of some suspicious food items with the disease.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ### Section goals
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       In this section you will learn how to:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         + estimate measures of association for categorical data
                                                                                                                                                                                                                                       + perform hypothesis tests for categorical data
                                                                                                                                                                                                                                       + investigate dose-response relationships in categorical data
                                                                                                                                                                                                                                       + perform stratified analysis
                                                                                                                                                                                                                                       + investigate potential confounders
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ### Analysis tasks
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       In this session, you will carry out a retrospective cohort study and complete the following tasks:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         + Calculate appropriate measures of association and 95% confidence intervals for food exposures
                                                                                                                                                                                                                                       + Perform appropriate hypothesis tests for the variables you identified
                                                                                                                                                                                                                                       + Check for a dose-response relationship between the food items you identified and being a case
                                                                                                                                                                                                                                       + After each step, interpret your results 
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ### Calculate measures of association
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       In R, measures of association are typically accessed via a model framework.  Models in R have four key components that you can choose: 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         + the model *type* (e.g. `glm`)
                                                                                                                                                                                                                                       + model *family* (e.g. `poisson`) 
                                                                                                                                                                                                                                       + the *link function* (e.g. `log`)
                                                                                                                                                                                                                                       + the method used for estimating error variance
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Different family / link function combinations yield different measures of association. Thus using `glm` as the model type:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         + For **odds ratios** choose:
                                                                                                                                                                                                                                         + `family = binomial` & 
                                                                                                                                                                                                                                         + `link = logit`
                                                                                                                                                                                                                                       + standard error variance
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       + For **relative risk ratios** choose:
                                                                                                                                                                                                                                         + `family = poisson` & 
                                                                                                                                                                                                                                         + `link = log` &
                                                                                                                                                                                                                                         + robust error variance
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       + For **incidence rate ratios** choose:
                                                                                                                                                                                                                                         + `family = poisson` &
                                                                                                                                                                                                                                         + `link = log` &
                                                                                                                                                                                                                                         + standard error variance
                                                                                                                                                                                                                                       + Add a time offset
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Note that for all ratio-based measures, it is usually necessary to exponentiate the coefficients from the model output.  The packages `broom` and `broom.mixed` (for mixed models) are designed to convert model outputs to a 'tidy' table of results.  The output tables typically include the coefficients (exponentiated if you choose that option) and their 95% confidence intervals, as well as *P* values.  The `gtsummary` package that we have already been using to look at counts and attack proportions also uses `broom` to tabulate model results.  
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       For this case study, we are particularly interested in calculating relative risk ratios, because we have already observed that the attack proportions are relatively high (> 10%); when this is the case, the confidence intervals calculated for odds ratios become less accurate.  
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       We could calculate relative risk using a poisson model with a log link and standard error variance, but the confidence intervals will be too wide.  In practice, this means the confidence intervals are more likely to cross 1 and fewer of them will have a significant *P* value.  This is why the error variance needs to be calculated with robust methods instead.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       In R, there are many packages that provide frameworks for executing glm poisson models; however there are much fewer options that include robust error variance.  Of these, each has different advantages and disadvantages.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       For example, in previous versions of this guide, we introduced the `epiR::epi.2by2()` function, which can be used to calculate risk ratios, odds ratios and other measures of epidemiological interest. However, a particular difficulty with this function is that it requires cross-tabulated data in a 2 by 2 table (as the name implies) and the values have to be presented in a specific order.  Creating the 2 by 2 table is an extra step that is more difficult to iterate through for multiple exposures.  In addition, if the input table cells are presented in the wrong order, this can lead to difficulties with interpretation.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       The package `gtsummary` which we have already been using, has a function `tbl_uvregression` which can also calculate odds ratios and relative risk.  The results are exported to a publication-ready table with little effort.  However, it is currently not possible to apply robust error variance with this function.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       We will therefore begin by demonstrating how to calculate odds ratios for multiple variables at once, using the `gtsummary::tbl_uvregression()` function.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       We will then introduce the `EpiStats::cstable()` function, which can take a vector of exposure column names as input and calculates risk, odds ratios and other measures.  The results are presented in a simple table (`data.frame`).  This function is very easy to use, but the output requires a little extra formatting before it can be transformed to a publishable table for reports.  
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       **R coding tips:**
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         To get started, we will pipe the list of exposure variables into `gtsummary::tbl_uvregression`.  We will calculate odds ratios by specifying the model method as `glm`, the family as `binomial` and link as `logit`.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       We will also specify that we only want single rows of output for binary exposures, and we will exponentiate the results to get odds ratios.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       **Table of risk ratios for food and drink exposures**
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r odds_ratios_table}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Pipe in the data:
                                                                                                                                                                                                                                       ortab <- linelist %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Select the variables to analyse:
                                                                                                                                                                                                                                         select(all_of(exposure_cols), case) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Remove missing values:
                                                                                                                                                                                                                                         drop_na() %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Calculate risk ratios and tabulate results:
                                                                                                                                                                                                                                         gtsummary::tbl_uvregression(
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Choose the model (generalised linear model)
                                                                                                                                                                                                                                           method = glm, 
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Name the outcome variable:
                                                                                                                                                                                                                                           y = case,
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Choose the model family:
                                                                                                                                                                                                                                           method.args = list(family = binomial(link = "logit")),
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Exponentiate the results:
                                                                                                                                                                                                                                           exponentiate = TRUE, 
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Show results for binary variables on a single row:
                                                                                                                                                                                                                                           show_single_row = exposure_cols
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                         ) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         gtsummary::as_flex_table()
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print the results table:
                                                                                                                                                                                                                                       ortab
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       **Questions to consider:**
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         Have a look at the output.  
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       1. What can you infer from this table? 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         2. Do the results help to identify any potential vehicles of infection?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         Because we know that odds ratios are not usually an appropriate measure of association for high attack proportions, we will now calculate relative risk ratios instead.  To do this, we will use the `EpiStats::cstable()` function, which is equivalent to a function of the same name in STATA.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       To see what the raw output looks like, after running this code, type `rrtab` in your console.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```{r rr_table_raw}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Pipe in the data:
                                                                                                                                                                                                                                       rrtab <- linelist %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Select the variables to analyse:
                                                                                                                                                                                                                                         select(all_of(exposure_cols), case) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Remove missing values:
                                                                                                                                                                                                                                         drop_na() %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Calculate risk ratios:
                                                                                                                                                                                                                                         EpiStats::cstable(
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Define outcome variable:
                                                                                                                                                                                                                                           cases = "case", 
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Define exposure columns:
                                                                                                                                                                                                                                           exposure = c(exposure_cols),
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Calculate Fisher's exact test for P values:
                                                                                                                                                                                                                                           exact = TRUE, 
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Sort output by relative risk:
                                                                                                                                                                                                                                           sort = "rr"
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                         )
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       The `EpiStats::cstable()` function produces simple tabular output that is sufficient for viewing and interpreting your results.  However, this format is not suitable for directly including in a report, and the column names are abbreviated, which makes them hard to interpret. 
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       In the code chunk below, we first extract the data.frame containing the tabular output. Column names are cleaned with `janitor::clean_names()` and  the row names are added to the table as the first column.  We use the `tidyr::unite()` function to bind the lower and upper confidence intervals together in a single column, as this makes them easier to read.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       We then convert the output to a publication ready table, using the package `flextable`.  Similar to a `ggplot` graph, flextables are built in layers and the functions in the package give very fine control over all of the features. In this code we have made adjustments to the text alignment of the columns and headers, made the header rows bold and italic, added some vertical borders between the sub-sections of the table and gave the columns some easy to interpret labels.  We also highlighted rows with a *p* value of less than 0.05 in yellow.    
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       **Table of relative risks for outbreak exposures: publication-ready**
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r rr_table_publication}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Define style for flextable border line
                                                                                                                                                                                                                                       border_style = officer::fp_border(color = "black", width = 1)
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Extract the data.frame from the list of outputs:
                                                                                                                                                                                                                                       rrtab_pub <- rrtab$df %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Clean column names:
                                                                                                                                                                                                                                         janitor::clean_names() %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Convert row names with exposures to first column:
                                                                                                                                                                                                                                         rownames_to_column(var = "exposure") %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Merge lower and upper 95% CI in a new column:
                                                                                                                                                                                                                                         tidyr::unite(col = "ci95", 
                                                                                                                                                                                                                                                      starts_with("ci_"), 
                                                                                                                                                                                                                                                      sep = " - ", 
                                                                                                                                                                                                                                                      remove = TRUE)  %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Convert to a flextable:
                                                                                                                                                                                                                                         flextable::flextable() %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Set column labels:
                                                                                                                                                                                                                                         flextable::set_header_labels(values = list(
                                                                                                                                                                                                                                           exposure = "Exposure",
                                                                                                                                                                                                                                           tot_exp = "Total",
                                                                                                                                                                                                                                           exp_cases = "Cases",
                                                                                                                                                                                                                                           ar_percent = "Attack %", 
                                                                                                                                                                                                                                           tot_unex = "Total", 
                                                                                                                                                                                                                                           unex_cases = "Cases", 
                                                                                                                                                                                                                                           ar_percent_2 = "Attack %", 
                                                                                                                                                                                                                                           rr = "RR",
                                                                                                                                                                                                                                           ci95 = "95% CI", 
                                                                                                                                                                                                                                           p_fisher = "P (Fisher)")) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add title header row:
                                                                                                                                                                                                                                         flextable::add_header_row(
                                                                                                                                                                                                                                           values = c("Exposure", 
                                                                                                                                                                                                                                                      "Exposed", 
                                                                                                                                                                                                                                                      "Unexposed", 
                                                                                                                                                                                                                                                      "Relative Risk", 
                                                                                                                                                                                                                                                      "P (Fisher)"), 
                                                                                                                                                                                                                                           colwidths = c(1, 3, 3, 2, 1)) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Merge cells in header rows:
                                                                                                                                                                                                                                         merge_at(i = 1:2, j = 1, part = "header") %>% 
                                                                                                                                                                                                                                         merge_at(i = 1:2, j = 10, part = "header") %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Right align numeric results columns:
                                                                                                                                                                                                                                         flextable::align(j = 2:10, 
                                                                                                                                                                                                                                                          align = "right", 
                                                                                                                                                                                                                                                          part = "body") %>%
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Center align top header row:
                                                                                                                                                                                                                                         flextable::align(i = 1, 
                                                                                                                                                                                                                                                          j = 2:9, 
                                                                                                                                                                                                                                                          align = "center", 
                                                                                                                                                                                                                                                          part = "header") %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Right align second header row:
                                                                                                                                                                                                                                         flextable::align(i = 2, 
                                                                                                                                                                                                                                                          j = 2:9, 
                                                                                                                                                                                                                                                          align = "right", 
                                                                                                                                                                                                                                                          part = "header") %>%
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Make merged cells on top header row bold:
                                                                                                                                                                                                                                         flextable::bold(i = 1:2, 
                                                                                                                                                                                                                                                         j = c(1, 10), 
                                                                                                                                                                                                                                                         bold = TRUE, 
                                                                                                                                                                                                                                                         part = "header") %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Make other cells on top header row bold:
                                                                                                                                                                                                                                         flextable::bold(i = 1, 
                                                                                                                                                                                                                                                         j = 2:9, 
                                                                                                                                                                                                                                                         bold = TRUE, 
                                                                                                                                                                                                                                                         part = "header") %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Make bottom header row italic:
                                                                                                                                                                                                                                         flextable::italic(i = 2, 
                                                                                                                                                                                                                                                           j = 2:9, 
                                                                                                                                                                                                                                                           italic = TRUE, 
                                                                                                                                                                                                                                                           part = "header") %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add highlighting of significant values:
                                                                                                                                                                                                                                         flextable::bg(i = ~ p_fisher < 0.05, 
                                                                                                                                                                                                                                                       j = 1:10,
                                                                                                                                                                                                                                                       bg = "yellow") %>%
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Add vertical borders between sections:
                                                                                                                                                                                                                                         flextable::vline(part = "all", j = 1, border = border_style) %>% 
                                                                                                                                                                                                                                         flextable::vline(part = "all", j = 4, border = border_style) %>%
                                                                                                                                                                                                                                         flextable::vline(part = "all", j = 7, border = border_style) %>%
                                                                                                                                                                                                                                         flextable::vline(part = "all", j = 9, border = border_style) %>%
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Autofit column width to text width:
                                                                                                                                                                                                                                         flextable::set_table_properties(
                                                                                                                                                                                                                                           width = 1, 
                                                                                                                                                                                                                                           layout = "autofit")
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print the results table:
                                                                                                                                                                                                                                       rrtab_pub
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       If you are interested in learning more about `flextable`, you can find some illustrated examples in [chapter 29 of the Epidemiologist R handbook](https://epirhandbook.com/en/tables-for-presentation.html).  Alternatively, you may wish to have a look at the [online flextable book](https://ardata-fr.github.io/flextable-book/) for coverage of more advanced features. 
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       **Questions to consider:**
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         1. Compare the odds ratios and risk ratios for each exposure - which do you think is more informative, and why?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         2. Considering the risk ratios, which food or drink items do you think were likely to be the vehicle(s) of infection in this outbreak?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         3. Do you think there are any confounders or effect modifiers?  If so, how would you investigate these further?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         \pagebreak
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ## Hypothesis testing
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       In this section, we will test specific hypotheses, to determine whether certain characteristics are associated with being a case (other than exposure to a potential food vehicle). The characteristics we can look at include:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         + sex
                                                                                                                                                                                                                                       + age
                                                                                                                                                                                                                                       + school class
                                                                                                                                                                                                                                       + group (student or teacher)
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       We can also look at potential assocations between each of these characteristics; for example we already saw in the age sex pyramid that there were more females than male cases; this appeared to be the case for all age groups, but we can investigate this further with a statistical test.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       For Hypothesis testing, we will use the `chisq.test()`, `wilcox.test()`, and `fisher.test()` functions. Before performing any statistical test in R, you will need to know the kind of data it accepts and what format the data should be in.  It is also useful to know if there are default settings for the function's arguments, and determine whether these default values will suit your objective or not.

For now, type `?chisq.test()` into your RStudio console to bring up the help page and find out more about the function. Alternatively, you can type `chisq.test` in the search bar of the help tab.

   + Which inputs does it require? 
   + What are the default settings for each of the function's arguments? 
                                                                                                                                                                                                                                         + Do they seem reasonable for our application? 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         Note that, as always, there are several different ways to perform these tests in R. [Chapter 18 of the Epidemiologist R handbook](https://epirhandbook.com/en/simple-statistical-tests.html) describes three different options to perform simple statistical tests; base R, with the `rstatix` package and with `gtsummary`, as we have already seen.  In the code below, as our main objective is exploratory, we will use a mix of base R and `janitor::tabyl`.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       **01. Is sex associated with being a case?** 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         We already had a look at potential associations between the sex of respondents and being a case, when we were calculating attack proportions with the `gtsummary` package. However, you may wish to investigate potential associations individually, before deciding what to include in a summary table.  
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Here we will perform a chi square test, after first creating a 2x2 cross-tabulation with the `janitor::tabyl()` function.  Note that `chisq.test()` expects a 2x2 matrix (numeric table) as input.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```{r htest_sex_case}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Start with linelist:
                                                                                                                                                                                                                                       sexcasetab <- linelist %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Create a 2x2 table with tabyl:
                                                                                                                                                                                                                                         janitor::tabyl(sex, case) %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Perform chi square test:
                                                                                                                                                                                                                                         janitor::chisq.test(tabyl_results = TRUE)
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Extract observed results:
                                                                                                                                                                                                                                       sexcasetab$observed
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Extract expected results:
                                                                                                                                                                                                                                       sexcasetab$expected
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print statistical results:
                                                                                                                                                                                                                                       sexcasetab
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       When interpreting the results, remember that a *P* value of less than 0.05 usually indicates that the null hypothesis (that there is no association between the two variables) can be rejected (i.e. there is an association between them). 
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       **Questions to consider:**
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         1. Bearing this in mind, what do these results tell you - is there an association between sex and being a case?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         2. Do these results differ from what you expected when looking at the descriptive figures (case proportions stratified by sex, or the age sex pyramid)?  
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         3. If so, why do you think this is?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         **02. Is school class associated with being a case?**
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         Here, you can either compare proportions using the chi-squared test as above, or use the Wilcoxon rank sum test (also called the Mann-Whitney U test) to compare distributions. Type `?wilcox.test()` in your RStudio console to bring up the help page and learn more about the function. 
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       The Wilcoxon rank sum test is used to determine if two numeric samples are from the same distribution, when their populations are not normally distributed or have unequal variance.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       In this case, `class` is both a numeric and a categorical variable; higher class numbers refer to older age groups.  During the data cleaning session, we converted `class` to a factor; conveniently factor levels are also represented by numbers, so we can treat `class` as a numeric variable by applying the function `as.numeric()`.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       We can first use the Shapiro-Wilk test to determine if `class` data follows a normal distribution or not:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r class_normtest}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Perform the Shapiro-Wilk test on class:
                                                                                                                                                                                                                                       shapiro.test(as.numeric(linelist$class))
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       We can see that the *P* value is less than 0.05, indicating that `class` deviates significantly from a normal distribution.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       An alternative way of checking if a variable is normally distributed or not, is to create a histogram:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r class_hist}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Create histogram of class:
                                                                                                                                                                                                                                       hist(as.numeric(linelist$class))
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       The histogram also shows a slightly left-skewed, non-parametric distribution.  The Wilcoxon rank sum test is therefore appropriate in this case:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r class_wilcox_test}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Perform the Wilcoxon rank sum test:
                                                                                                                                                                                                                                       wilcox.test(as.numeric(class) ~ case, data = linelist)
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Note that in base R, this test uses formula notation, where the two variables you are assessing for an association are separated by a tilde (`~`).  In addition, the first variable is expected to be numeric.  
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       What do these results tell you - is there an association between class number and being a case? 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         If so, what is it?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         **03. Is there a difference between age in males and females?** 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         Age is a numeric variable; therefore we could perform a student's t-test if the data are normally distributed.  If they are not, we can again return to the Wilcoxon rank sum test.

You may already remember that this outbreak has a heavily skewed age distribution, because most of the people affected were teenage students.

We can check first of all if age in general is normally distributed or not:

```{r age_norm_test}

# Check if age overall follows a normal distribution:
shapiro.test(linelist$age)

```

&nbsp;
&nbsp;

As you may have suspected, age overall is not normally distributed, due to the large number of teenagers and small number of older adult (teachers) in the affected population.

But what about the age distribution among students?

```{r age_norm_test_students}

# Check if age of students follows a normal distribution:
linelist %>% 
  
  filter(group == "student") %>% 
  
  select(age) %>% 
  
  pull() %>% 
  
  shapiro.test()

```

&nbsp;
&nbsp;

Note that `shapiro.test()` expects a numeric variable as input; here we have used `filter()`, `select()` and `pull()` to pass a variable of the correct format to the test.

Unfortunately, the results show that age still deviates significantly from a normal distribution, even among students.  


*Note:*

You may have noticed that low *P* values are being presented in scientific notation, which can be hard to read.  You can switch this feature off in your R session by typing `options(scipen = 999)` in your RStudio console or at the top of your R script.


Next we will perform a Wilcoxon rank sum test to look at age distribution by sex.  Remember that the first argument must be numeric:

```{r agesex_wilcox_test}

# Perform Wilcoxon rank sum test on age and sex:
wilcox.test(age ~ sex, data = linelist)


```

&nbsp;
&nbsp;


**Questions to consider:**

  1. What do the results tell you - is there an association between age and sex?  

  2. If yes, what is it?


\pagebreak


## Dose response

In this section, we will look at the dose response variables, which indicate for each food or drink item how many portions or glasses each respondent consumed.  This may give us a better idea of whether there is a dose response effect with any of the suspected vehicles, and if so, which one(s) have the strongest effect.  

Dose-response analysis can be particularly useful to tease apart potential vehicles in a foodborne outbreak when there has been cross-contamination.  Typically, the main contaminant will have a stronger dose-response effect.

Let's have a look first at our top contenders (hint: it is veal and pasta!).  We can use the Wilcoxon rank sum test again:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r dose_response_veal}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Perform the Wilcoxon rank sum test on number of veal portions:
                                                                                                                                                                                                                                       wilcox.test(vealD ~ case, data = linelist)
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Now what about pasta?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r dose_response_pasta}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Perform the Wilcoxon rank sum test on number of veal portions:
                                                                                                                                                                                                                                       wilcox.test(pastaD ~ case, data = linelist)
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       **Questions to consider:**
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         1. Based on these results, which of the two potential vehicles has a stronger dose response effect?  
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         2. Why do you think this is the case?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         We can quickly iterate through the rest of the dose response variables using the `purrr::map()` function.  `purrr` is another tidyverse package, and works in a similar way to the `across()` and `if_any()` or `if_all()` functions, in that it takes a list of variables and a function as input and will apply the function to each variable in the list.  In this case, `.x` is used as the wild card in the formula (standing in for variable names) and we have pasted the formula together for `wilcox.test()` (remember it takes the format `numeric ~ response variable`). 
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```{r doseresponse_vars_rr}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ### Pipe in the data:
                                                                                                                                                                                                                                       rrdrtab <- linelist %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Select the variables to analyse:
                                                                                                                                                                                                                                         select(ends_with("D", ignore.case = FALSE), case) 
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ### Create list of dose response variables:
                                                                                                                                                                                                                                       dr_cols <- names(rrdrtab)[!names(rrdrtab) %in% c("case")]
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ### Pass dose response columns to formula:
                                                                                                                                                                                                                                       dr_cols %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Set dose resonse column names:
                                                                                                                                                                                                                                         set_names() %>%
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Map them to the wilcox.test function:
                                                                                                                                                                                                                                         purrr::map(.f = ~ wilcox.test(
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Name the data set:
                                                                                                                                                                                                                                           data = linelist, 
                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                           # Paste together the test formula, using '.x' as a wild card:
                                                                                                                                                                                                                                           as.formula(str_c(.x,"~","case"))))
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Now that you can see the rest of the dose response results, are there any that surprise you?  
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         If so can you think of an explanation? (hint: think about effect modifiers and confounders).  
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       \pagebreak
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ## Stratifiers & confounders
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ### Introduction
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       In the last section, we saw that those eating pasta or veal as well as drinking champagne have the highest risk of becoming ill. There are, however, many other food items that are associated with an increased risk. Consequently, we need to check for effect modification and confounding by stratifying the analysis. 
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ### Section goals
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       In this section of the case study you will learn to:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         + perform simple stratified analysis 
                                                                                                                                                                                                                                       + using the *Mantel-Haenszel* approach
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Please note that in reality, you would much more likely be using *Regression Models* to account for confounding and check for effect modification. The use of the *Mantel-Haenszel* approach explained here, is an intermediate step chosen for pedagogic purposes, as it leads to introduction of regression modelling in the next *EPIET* modules. 
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ### Stratification
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       In this section, you will:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         + Stratify your analysis by having:
                                                                                                                                                                                                                                         + eaten veal
                                                                                                                                                                                                                                       + eaten pasta
                                                                                                                                                                                                                                       + drunk champagne
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       + Describe your findings: 
                                                                                                                                                                                                                                         + Do you see any confounding? 
                                                                                                                                                                                                                                         + Did you find effect modification?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         **R coding tips:**
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         To perform stratified analysis, we will use another function from the `EpiStats` package, `csinter()`.  This function requires the data set, case, exposure and stratifier columns as input.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       First we will convert the relevant variables to numeric (0 and 1) as this is the format required by `csinter`:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r back2binary}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Convert exposures of interest to numeric:
                                                                                                                                                                                                                                       stratall <- linelist %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Mutate across to convert them to numeric:
                                                                                                                                                                                                                                         mutate(across(.cols = c(case, pasta, veal, champagne), 
                                                                                                                                                                                                                                                       .fns = ~ as.numeric(.)))
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Lets begin by calculating the relative risk for being a case having eaten pasta, when stratified by consumption of veal:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         **Crude and adjusted risk ratios for pasta stratified by veal** 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r veal_stratifier}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Pass data to the csinter function:
                                                                                                                                                                                                                                       vealstrata <- csinter(x = stratall, 
                                                                                                                                                                                                                                                             cases = "case", 
                                                                                                                                                                                                                                                             exposure = "pasta", 
                                                                                                                                                                                                                                                             by = "veal")
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Extract second data.frame with summary results:
                                                                                                                                                                                                                                       vealstrata_pub <- vealstrata$df2 %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Convert to a flextable:
                                                                                                                                                                                                                                         flextable::qflextable()
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print table:
                                                                                                                                                                                                                                       vealstrata_pub
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Note that the output of the `csinter` function has a lot of detail in it, but typically the results that you will need are stored in the second data.frame.  The output has stored multiple data.frames as a list of objects; you can access a data.frame within the list by typing the name that you gave the output (in this case `vealstrata`) followed by a dollar sign and the name of the data.frame you are interested in: thus `vealstrata$df2` will print the second data.frame.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       We can now continue with the second stratifier, pasta:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         **Crude and adjusted risk ratios for veal stratified by pasta** 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r pasta_stratifier}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Pass data to the csinter function:
                                                                                                                                                                                                                                       pastastrata <- csinter(x = stratall, 
                                                                                                                                                                                                                                                              cases = "case", 
                                                                                                                                                                                                                                                              exposure = "veal", 
                                                                                                                                                                                                                                                              by = "pasta")
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Extract second data.frame with summary results:
                                                                                                                                                                                                                                       pastastrata_pub <- pastastrata$df2 %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Convert to a flextable:
                                                                                                                                                                                                                                         flextable::qflextable()
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print table:
                                                                                                                                                                                                                                       pastastrata_pub
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Lastly, we can look at champagne (as the exposure of interest) and see what effect having also eaten pasta has on the risk of becoming ill:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         **Crude and adjusted risk ratios for champagne stratified by pasta** 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ```{r champ_stratifier}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Pass data to the csinter function:
                                                                                                                                                                                                                                       champstrata <- csinter(x = stratall, 
                                                                                                                                                                                                                                                              cases = "case", 
                                                                                                                                                                                                                                                              exposure = "champagne", 
                                                                                                                                                                                                                                                              by = "pasta")
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Extract second data.frame with summary results:
                                                                                                                                                                                                                                       champstrata_pub <- champstrata$df2 %>% 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Convert to a flextable:
                                                                                                                                                                                                                                         flextable::qflextable()
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Print table:
                                                                                                                                                                                                                                       champstrata_pub
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       **Questions to consider:**
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         1. What can you conclude from these stratifications?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         2. Is it any clearer which of the exposures among pasta, veal and champagne is the most likely vehicle of infection?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         (Hint: as a rule of thumb, more than 10% difference between the crude and MH-adjusted relative risk is siginficant).
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       \pagebreak
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ### Confounding
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       It appears that pasta confounds the association between eating veal and being a case. For a variable to be a confounder it needs to be associated both with the outcome (being a case) and with the exposure. We know from univariable analysis that pasta is associated with being a case; we can now check if it is also associated with veal.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```{r pasta_veal_assoc}
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       # Start with the linelist:
                                                                                                                                                                                                                                       linelist %>% 
                                                                                                                                                                                                                                         drop_na(pasta, veal) %>% 
                                                                                                                                                                                                                                         tabyl(pasta, veal) %>% 
                                                                                                                                                                                                                                         fisher.test()
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ```
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       &nbsp;
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       **Questions to consider:**
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         1. What can you conclude from these results?  
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         2. Is there an association between pasta and veal?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         \newpage
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ------------------------------------------------------------------------
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         # Conclusions {.tabset .tabset-pills}
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ## Reflections
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         Summarize your analysis and findings: 
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         + Recall the steps you undertook in this case study and describe the intermediate findings at each step
                                                                                                                                                                                                                                       + Which difficulties did you have at each of the steps? 
                                                                                                                                                                                                                                         + Could any of these have been prevented by setting up data collection differently or changing anything prior to data analysis?
                                                                                                                                                                                                                                         + Which new `R` concepts did you learn?
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         \pagebreak
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ## Bonus task - R markdown report
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       If you wish, create an analysis report that describes the steps you undertook and summarizes your findings utilizing `R markdown` and `knitr`. Include visualizations, such as tables, graphs, and the epicurve. While voluntary, you will be profiting greatly from this exercise because this task involves going through your documents and scripts again, helping with recall and repetition. Reports like this will be required from you in each and every outbreak investigation. Using `R` for creating reports rather than other software like *MS word* has the advantage of making your research *reproducible*:
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         + Your report is the result of *code* - as such it can be executed by anyone and will always yield the same result
                                                                                                                                                                                                                                       + Everything is in one place: no juggling of different files, manual changes, different versions
                                                                                                                                                                                                                                       + The document will serve as a record for how you arrived at the results you include in your papers - this makes your research transparent and is immensely helpful to defend your findings against criticism
                                                                                                                                                                                                                                       + Dynamic documents can change as data are updated
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       For more information and a practical introduction to `markdown`, please refer to [*R Studio* Introduction to *R markdown*](https://rmarkdown.rstudio.com/lesson-1.html),  [*R for Data Science* chapter on *reproducible research*](https://r4ds.had.co.nz/r-markdown.html), and the [*R markdown* cheat sheet](https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf).
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       \pagebreak
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ## Summary
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       ### Descriptive analyses
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       We didn't find anything surprising in the descriptive analysis of the cohort's age given it consists of two groups, the students and the teachers.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       The distribution of the cohort regarding sex, group and class also didn't reveal anything unusual. Students seem a bit more affected by the outbreak than teachers and the attack rate is higher for older students in higher classes. This, however, is a purely descriptive result.

When constructing an epicurve, we need to decide on the resolution, i.e. the time interval for a single bar. A rule of thumb is to use one third or one fourth of the average incubation period as an interval. For our investigation this means we should use approximately a 6h interval.

This seems a good choice, as we saw that the daily interval was too coarse to really see the signal we're after. The epicurve and the summary of the incubation period show that there seemed to be a rapid onset of symptoms following exposure. This is in line with our previous suspicion that a virus or a toxin might be the causative agent in the outbreak.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       The unimodal shape with the sharp peak suggests a point source, while the tail on the right hand side could be explained by secondary cases or background noise. Also people that only consumed a little contaminated food and therefore only a low infectious dose could have a longer incubation period and could explain the late cases.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       The above results are in line with norovirus as the prime suspect, but the symptoms are not a textbook fit. There are too few people that experienced vomiting!
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ### Univariate analyses
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         The interesting results here are that the two food items that are most suspicious are pasta and veal. In particular, the dose response relationship that was found for pasta points towards pasta as the potential vehicle. Pasta as such is unlikely to be contaminated, but as you can see in the label, it was served with pesto!
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         Before you jump to conclusions, be aware that this result could be due to confounding! Maybe pasta was clean but eaten by all the people who ate the food item that actually was contaminated!
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         ### Stratified analyses
                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                         We found that pasta consumption confounds the association between eating veal and being ill. The crude (univariable) result for veal suggests that veal is a risk factor (crude RR = 1.73, CI: 1.12 - 2.67), but when we adjust for the consumption of pasta we see that actually this result is due to the fact that most people who ate veal also ate pasta.
                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                       Within the stratum of the people who ate pasta, veal has no effect (RR = 1.20, CI: 0.60 - 2.41). The same holds within the stratum of people who didn't eat pasta (RR = 0.99, CI = 0.34, 2.91). This is why the adjusted MH-RR also suggests that veal has no effect (RRadj = 1.12, CI: 0.62 - 2.02).

This result taken together with the dose response relationship we found earlier for pasta gives additional evidence that there was something going on with the pesto!


### Conclusions of the investigation

In summary, it is fair to say that there was both epidemiological and microbiological evidence that the pasta salad with pesto was the most likely vehicle of transmission in this outbreak. Further investigations focused on how the pasta salad with pesto could have become contaminated and on lessons learned from this outbreak that could then be communicated both to the scientific community, the caterer and the general public.



\pagebreak


## References


  1. Batra, N., Mousset, M., Spina, A., Florence, I., Liza, Aminatand, Laurenson-Schafer, H., Fischer, N., Molling, D., Polonsky, J., Bailey-C, Ebuajitti, Blomquist, P., Campbell, F., Hollis, S., Whoinfluenza, Llhaskins, Yurie, & Michellesloan. (2021). [Applied Epi Epidemiologists R handbook:](https://doi.org/10.5281/ZENODO.4752646) v1.0_eng initial release (v1.0_eng) [Computer software]. Zenodo. 
  
  2. Morgenstern, H., Kleinbaum, D. G., & Kupper, L. L. (1980). [Measures of Disease Incidence Used in Epidemiologic Research. International Journal of Epidemiology, 9(1), 97104.](https://doi.org/10.1093/ije/9.1.97)
  
  3. Rothman, K. J., Lash, T. L., VanderWeele, T. J., & Haneuse, S. (2021). Modern epidemiology (Fourth edition). Wolters Kluwer.
  
  4. Wickham, H. (n.d.). [Tidy Verse - R packages for data science.](https://www.tidyverse.org/)
  
  5. Wickham, H. (2009). [Ggplot2: elegant graphics for data analysis. Springer.](https://ggplot2-book.org/)
  
  6. Wickham, H. (2019). [Advanced R (Second edition). CRC Press/Taylor and Francis Group.](https://adv-r.hadley.nz/)
  
  7. Wickham, H., & Grolemund, G. (2016). [R for data science: import, tidy, transform, visualize, and model data (First edition). OReilly.](https://r4ds.had.co.nz/)


